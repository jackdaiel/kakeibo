<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D's Finance</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;500;600&family=Noto+Sans+JP:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --ink: #1a1814;
    --paper: #f5f0e8;
    --cream: #ede8dc;
    --red: #c0392b;
    --gold: #9b7c3d;
    --gold-light: #c9a855;
    --border: #c8bfa8;
    --muted: #8a7f6e;
    --green: #2e6b45;
    --blue: #2c4a7c;
    --purple: #6b3fa0;
    --font: 'Noto Sans JP', sans-serif;
    --font-serif: 'Noto Serif JP', serif;
    --font-mono: 'DM Mono', monospace;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:var(--font); background:var(--paper); color:var(--ink); min-height:100vh; font-weight:300; font-size:17px; }

  /* â”€â”€ HEADER â”€â”€ */
  header { background:var(--ink); position:sticky; top:0; z-index:100; box-shadow:0 2px 16px rgba(0,0,0,.3); }
  .hdr { display:flex; align-items:center; justify-content:space-between; padding:0 1.5rem; height:60px; gap:1rem; }
  .logo { font-size:1.25rem; color:var(--gold-light); letter-spacing:.15em; font-weight:600; white-space:nowrap; font-family:var(--font-serif); }
  .hdr-center { display:flex; align-items:center; gap:.6rem; }
  .hdr-center label { font-size:.75rem; color:rgba(255,255,255,.5); letter-spacing:.1em; }
  .hdr-center select { background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.2); color:#fff; padding:.3rem .5rem; border-radius:4px; font-family:var(--font); font-size:.82rem; cursor:pointer; }
  .hdr-center select option { background:var(--ink); }
  .btn { padding:.4rem .9rem; border:none; border-radius:4px; cursor:pointer; font-family:var(--font); font-size:.8rem; transition:all .15s; letter-spacing:.05em; }
  .btn-outline { background:transparent; color:var(--gold-light); border:1px solid var(--gold); font-weight:400; }
  .btn-outline:hover { background:rgba(155,124,61,.15); }

  /* â”€â”€ NAV â”€â”€ */
  .nav { background:var(--cream); border-bottom:2px solid var(--border); display:flex; overflow-x:auto; align-items:stretch; }
  .nav-section { display:flex; border-right:1px solid var(--border); }
  .nav-section.mc-section { border-left:1px solid var(--border); margin-left:auto; background:rgba(107,63,160,.03); }
  .nav-section:last-child { border-right:none; }
  .tab { padding:.9rem 1.3rem; cursor:pointer; font-size:1rem; color:var(--muted); border-bottom:3px solid transparent; margin-bottom:-2px; white-space:nowrap; transition:all .15s; font-weight:400; letter-spacing:.03em; }
  .tab:hover { color:var(--ink); }
  .tab.active { color:var(--red); border-bottom-color:var(--red); font-weight:600; }
  /* å…¥åŠ›ã‚¿ãƒ–ã‚’å¼·èª¿ */
  #tab-entry { color:var(--red); font-weight:600; font-size:1.08rem; background:rgba(192,57,43,.06); }
  #tab-entry.active { background:rgba(192,57,43,.12); }
  /* mycar ã‚¿ãƒ–ã‚’æ§ãˆã‚ã« */
  .tab.mc-tab { font-size:.88rem; color:#b0a0c8; padding:.9rem 1rem; font-weight:300; letter-spacing:.03em; }
  .tab.mc-tab:hover { color:var(--purple); }
  .tab.mc-tab.active { color:var(--purple); border-bottom-color:var(--purple); font-weight:500; }
  .nav-divider { width:1px; background:var(--border); margin:.4rem 0; }

  /* â”€â”€ MAIN â”€â”€ */
  .main { max-width:1200px; margin:0 auto; padding:1.8rem 1.5rem; }
  .hidden { display:none !important; }
  .sec-title { font-size:.95rem; color:var(--ink); margin-bottom:1rem; padding-bottom:.5rem; border-bottom:1px solid var(--border); letter-spacing:.1em; font-weight:500; font-family:var(--font-serif); }

  /* â”€â”€ STAT CARDS â”€â”€ */
  .stat-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-bottom:1.8rem; }
  .stat-card { background:#fff; border:1px solid var(--border); border-radius:6px; padding:1.1rem 1.3rem; position:relative; overflow:hidden; }
  .stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; }
  .stat-card.inc::before { background:var(--green); }
  .stat-card.exp::before { background:var(--red); }
  .stat-card.sav::before { background:var(--blue); }
  .stat-lbl { font-size:.85rem; color:var(--muted); letter-spacing:.1em; margin-bottom:.4rem; }
  .stat-val { font-size:1.5rem; font-weight:500; font-family:var(--font-mono); }
  .stat-val.neg { color:var(--red); }
  .stat-val.pos { color:var(--green); }
  .stat-sub { font-size:.82rem; color:var(--muted); margin-top:.2rem; font-family:var(--font-mono); }

  /* â”€â”€ TABLES â”€â”€ */
  .tbl-wrap { overflow-x:auto; background:#fff; border:1px solid var(--border); border-radius:6px; margin-bottom:1.8rem; }
  table { width:100%; border-collapse:collapse; font-size:.82rem; }
  th { background:var(--ink); color:#fff; padding:.55rem .7rem; text-align:right; font-weight:400; font-size:.82rem; white-space:nowrap; letter-spacing:.03em; }
  th:first-child, th:nth-child(2) { text-align:left; }
  td { padding:.52rem .7rem; text-align:right; border-bottom:1px solid var(--cream); white-space:nowrap; font-weight:300; font-family:var(--font-mono); font-size:.9rem; }
  td:first-child, td:nth-child(2) { text-align:left; font-weight:300; font-family:var(--font); }
  tr:hover td { background:rgba(245,240,232,.4); }
  tr.sub td { background:var(--cream); font-weight:500; }
  tr.sav-row td { background:#eef3f8; color:var(--blue); font-weight:500; }
  tr.sv-total td { background:#2c3e50; color:#fff; font-weight:500; }
  tr.sv-diff td { background:#eef6f0; color:var(--green); font-weight:500; }
  tr.sv-cum td { background:#eaf0f8; color:var(--blue); font-weight:500; }
  .neg { color:var(--red); }
  .c-pos { color:var(--green); }
  .c-neg { color:var(--red); }

  /* â”€â”€ ENTRY LAYOUT â”€â”€ */
  .entry-layout { display:grid; grid-template-columns:350px 1fr; gap:1.5rem; align-items:start; }
  .panel { background:#fff; border:1px solid var(--border); border-radius:8px; overflow:hidden; position:sticky; top:70px; }
  .panel-hdr { background:var(--ink); color:var(--gold-light); padding:.9rem 1.3rem; font-size:.9rem; letter-spacing:.1em; font-weight:500; font-family:var(--font-serif); }
  .panel-hdr.mc { background:var(--purple); }

  .step { padding:1rem 1.3rem; border-bottom:1px solid var(--cream); }
  .step-lbl { font-size:.78rem; color:var(--muted); letter-spacing:.12em; text-transform:uppercase; margin-bottom:.7rem; }

  /* Mode toggle */
  .mode-row { display:grid; grid-template-columns:1fr 1fr; gap:.5rem; }
  .mode-btn { padding:.8rem .4rem; border:2px solid var(--border); border-radius:6px; background:var(--paper); cursor:pointer; text-align:center; transition:all .15s; }
  .mode-btn .icon { font-size:1.4rem; display:block; margin-bottom:.25rem; }
  .mode-btn .lbl { font-size:.95rem; font-weight:400; color:var(--muted); letter-spacing:.05em; }
  .mode-btn:hover { border-color:var(--gold); background:#fff; }
  .mode-btn.sel-exp { border-color:var(--red); background:#fdf4f3; }
  .mode-btn.sel-exp .lbl { color:var(--red); font-weight:500; }
  .mode-btn.sel-inc { border-color:var(--green); background:#f0f8f3; }
  .mode-btn.sel-inc .lbl { color:var(--green); font-weight:500; }

  /* Category grid */
  .cat-grid { display:grid; grid-template-columns:1fr 1fr; gap:.45rem; }
  .cat-btn { padding:.55rem .4rem; border:1px solid var(--border); border-radius:5px; background:var(--paper); cursor:pointer; text-align:center; transition:all .15s; }
  .cat-btn .icon { font-size:1rem; display:block; margin-bottom:.15rem; }
  .cat-btn .lbl { font-size:.82rem; color:var(--muted); letter-spacing:.03em; }
  .cat-btn:hover { border-color:var(--gold); background:#fff; }
  .cat-btn.sel { border-color:var(--red); background:#fdf4f3; }
  .cat-btn.sel .lbl { color:var(--red); font-weight:500; }
  .cat-btn.inc-cat.sel { border-color:var(--green); background:#f0f8f3; }
  .cat-btn.inc-cat.sel .lbl { color:var(--green); font-weight:500; }
  .cat-btn.mc-cat.sel { border-color:var(--purple); background:#f5f0fa; }
  .cat-btn.mc-cat.sel .lbl { color:var(--purple); font-weight:500; }

  /* Fields */
  .fields { display:flex; flex-direction:column; gap:.6rem; }
  .fg { display:flex; flex-direction:column; gap:.25rem; }
  .fg label { font-size:.82rem; color:var(--muted); letter-spacing:.08em; }
  .fg input, .fg select { border:1px solid var(--border); border-radius:4px; padding:.55rem .7rem; font-family:var(--font); font-size:.95rem; background:var(--paper); color:var(--ink); width:100%; transition:border-color .15s; font-weight:300; }
  .fg input:focus, .fg select:focus { outline:none; border-color:var(--gold); background:#fff; }
  .frow { display:grid; grid-template-columns:1fr 1fr; gap:.6rem; }

  /* Memo candidates */
  .memo-candidates { display:flex; flex-wrap:wrap; gap:.3rem; margin-top:.35rem; align-items:center; }
  .memo-chip { padding:.25rem .6rem; border:1px solid var(--border); border-radius:12px; font-size:.8rem; color:var(--muted); cursor:pointer; background:#fff; transition:all .12s; font-family:var(--font); font-weight:300; white-space:nowrap; }
  .memo-chip:hover { border-color:var(--gold); color:var(--ink); background:var(--cream); }
  .memo-edit-btn { padding:.18rem .5rem; border:1px dashed var(--border); border-radius:12px; font-size:.68rem; color:var(--border); cursor:pointer; background:transparent; font-family:var(--font); transition:all .12s; white-space:nowrap; }
  .memo-edit-btn:hover { border-color:var(--gold); color:var(--gold); }

  /* Modal */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:200; display:flex; align-items:center; justify-content:center; padding:1rem; }
  .modal-overlay.hidden { display:none; }
  .modal { background:#fff; border-radius:10px; width:100%; max-width:420px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.3); }
  .modal-hdr { background:var(--ink); color:var(--gold-light); padding:.9rem 1.3rem; display:flex; align-items:center; justify-content:space-between; }
  .modal-hdr h3 { font-size:.95rem; font-weight:500; letter-spacing:.08em; }
  .modal-close { background:none; border:none; color:rgba(255,255,255,.6); font-size:1.3rem; cursor:pointer; line-height:1; padding:.1rem .3rem; }
  .modal-close:hover { color:#fff; }
  .modal-body { padding:1.2rem 1.3rem; }
  .modal-chip-list { display:flex; flex-wrap:wrap; gap:.4rem; margin-bottom:1rem; min-height:2.5rem; }
  .modal-chip { display:flex; align-items:center; gap:.3rem; padding:.22rem .6rem; border:1px solid var(--border); border-radius:12px; font-size:.78rem; background:var(--paper); font-family:var(--font); }
  .modal-chip-del { background:none; border:none; color:var(--border); cursor:pointer; font-size:.85rem; line-height:1; padding:0; }
  .modal-chip-del:hover { color:var(--red); }
  .modal-add-row { display:flex; gap:.5rem; }
  .modal-add-row input { flex:1; border:1px solid var(--border); border-radius:4px; padding:.45rem .65rem; font-family:var(--font); font-size:.85rem; background:var(--paper); }
  .modal-add-row input:focus { outline:none; border-color:var(--gold); background:#fff; }
  .modal-add-row button { padding:.45rem .9rem; background:var(--gold); color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:var(--font); font-size:.82rem; white-space:nowrap; }
  .modal-add-row button:hover { background:var(--gold-light); }

  .submit-btn { width:100%; padding:.9rem; background:var(--red); color:#fff; border:none; border-radius:5px; font-family:var(--font-serif); font-size:1.05rem; cursor:pointer; letter-spacing:.08em; transition:background .15s; margin-top:.2rem; font-weight:400; }
  .submit-btn:hover { background:#a93226; }
  .submit-btn.inc { background:var(--green); }
  .submit-btn.inc:hover { background:#245538; }
  .submit-btn.mc-sub { background:var(--purple); }
  .submit-btn.mc-sub:hover { background:#5a3388; }

  /* Entry list */
  .elist { background:#fff; border:1px solid var(--border); border-radius:6px; overflow:hidden; }
  .mhdr { background:var(--cream); padding:.55rem .9rem; font-size:.8rem; color:var(--muted); font-weight:400; display:flex; justify-content:space-between; align-items:center; }
  .mttl { font-weight:500; color:var(--ink); font-family:var(--font-mono); }
  .ei { padding:.6rem .9rem; display:flex; align-items:center; gap:.65rem; border-bottom:1px solid var(--cream); transition:background .1s; }
  .ei:last-child { border-bottom:none; }
  .ei:hover { background:rgba(245,240,232,.5); }
  .edate { font-size:.76rem; color:var(--muted); width:44px; flex-shrink:0; font-family:var(--font-mono); }
  .ebadge { font-size:.75rem; color:#fff; padding:.1rem .38rem; border-radius:10px; flex-shrink:0; letter-spacing:.02em; }
  .b-inc { background:var(--green); }
  .b-exp { background:var(--muted); }
  .b-mc  { background:var(--purple); }
  .etext { flex:1; font-size:.9rem; font-weight:300; }
  .eamt { font-size:.95rem; font-weight:500; text-align:right; min-width:75px; font-family:var(--font-mono); }
  .eamt.inc-c { color:var(--green); }
  .edel { background:none; border:none; color:var(--border); cursor:pointer; font-size:.95rem; padding:.15rem; transition:color .15s; }
  .edel:hover { color:var(--red); }
  .empty { text-align:center; padding:2.5rem; color:var(--muted); }
  .empty .icon { font-size:2.2rem; display:block; margin-bottom:.4rem; opacity:.4; }
  .empty p { font-size:.82rem; font-weight:300; }

  /* Filter bar */
  .fbar { display:flex; flex-wrap:wrap; gap:.4rem; margin-bottom:.9rem; align-items:center; }
  .flbl { font-size:.76rem; color:var(--muted); }
  .fp { padding:.38rem .85rem; border:1px solid var(--border); border-radius:20px; background:#fff; color:var(--muted); font-size:.85rem; cursor:pointer; transition:all .15s; font-family:var(--font); font-weight:300; }
  .fp:hover { border-color:var(--ink); color:var(--ink); }
  .fp.on { background:var(--ink); color:#fff; border-color:var(--ink); }

  /* Savings */
  .sv-bar { background:#fff; border:1px solid var(--border); border-radius:6px; padding:1rem 1.2rem; margin-bottom:.9rem; display:flex; flex-direction:column; gap:.7rem; }
  .sv-bar .fg { width:100%; }
  .sv-bar .sv-row { display:grid; grid-template-columns:1fr 1fr; gap:.7rem; }
  .sv-bar input, .sv-bar select { width:100%; border:1px solid var(--border); border-radius:4px; padding:.48rem .65rem; font-family:var(--font); font-size:.9rem; background:var(--paper); color:var(--ink); font-weight:300; }
  .sv-bar input:focus, .sv-bar select:focus { outline:none; border-color:var(--gold); background:#fff; }

  /* mycar sub-links */
  .mc-sublinks { display:flex; align-items:center; gap:.5rem; margin-top:1.2rem; padding:.6rem 0; border-top:1px solid var(--cream); }
  .mc-sublinks span { font-size:.85rem; color:var(--muted); cursor:pointer; transition:color .15s; }
  .mc-sublinks span:hover { color:var(--purple); text-decoration:underline; }
  .mc-sublinks-sep { color:var(--border); pointer-events:none; }
  .mc-sub-panel { margin-top:1rem; border:1px solid var(--border); border-radius:8px; overflow:hidden; }
  .mc-sub-panel-hdr { background:var(--cream); padding:.6rem 1rem; display:flex; align-items:center; justify-content:space-between; font-size:.88rem; font-weight:500; color:var(--ink); }
  .mc-sub-panel-hdr button { background:none; border:none; color:var(--muted); cursor:pointer; font-size:.8rem; font-family:var(--font); padding:.1rem .3rem; }
  .mc-sub-panel-hdr button:hover { color:var(--red); }
  .mc-sub-panel .fbar { padding:.6rem .8rem 0; }

  /* TOAST */
  .toast { position:fixed; bottom:1.8rem; right:1.8rem; background:var(--ink); color:#fff; padding:.7rem 1.1rem; border-radius:6px; font-size:.83rem; opacity:0; transform:translateY(10px); transition:all .3s; pointer-events:none; z-index:1000; border-left:3px solid var(--gold); font-weight:300; }
  .toast.show { opacity:1; transform:translateY(0); }

  @media(max-width:900px) { .entry-layout{grid-template-columns:1fr;} .panel{position:static;} .stat-grid{grid-template-columns:1fr 1fr;} }
  @media(max-width:500px) { .stat-grid{grid-template-columns:1fr;} .hdr{padding:0 1rem;} }
</style>
</head>
<body>

<header>
  <div class="hdr">
    <div class="logo">D's Finance</div>
    <div class="hdr-center">
      <label>å¹´åº¦</label>
      <select id="yrSel" onchange="changeYear(this.value)"></select>
    </div>
    <div></div>
  </div>
</header>

<div class="nav">
  <!-- å®¶è¨ˆç°¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="nav-section">
    <div class="tab active" onclick="showTab('summary')" id="tab-summary">ğŸ“‹ ç·åˆ</div>
    <div class="tab" onclick="showTab('entry')" id="tab-entry">âœï¸ å…¥åŠ›</div>
    <div class="tab" onclick="showTab('history')" id="tab-history">ğŸ“– å±¥æ­´</div>
  </div>
  <!-- mycar ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå…¥åŠ›ã®ã¿ï¼‰ -->
  <div class="nav-section mc-section">
    <div class="tab mc-tab" onclick="showTab('mc-entry')" id="tab-mc-entry">ğŸš— mycar</div>
  </div>
</div>

<div class="main">

  <!-- â•â•â•â•â•â•â•â•â•â• SUMMARY â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-summary">
    <div class="stat-grid" id="statCards"></div>
    <div class="sec-title">æœˆåˆ¥åæ”¯ä¸€è¦§</div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th style="text-align:left">åŒºåˆ†</th><th style="text-align:left">é …ç›®</th>
          <th>ï¼”æœˆ</th><th>ï¼•æœˆ</th><th>ï¼–æœˆ</th><th>ï¼—æœˆ</th><th>ï¼˜æœˆ</th><th>ï¼™æœˆ</th>
          <th>ï¼‘ï¼æœˆ</th><th>ï¼‘ï¼‘æœˆ</th><th>ï¼‘ï¼’æœˆ</th><th>ï¼‘æœˆ</th><th>ï¼’æœˆ</th><th>ï¼“æœˆ</th>
          <th>è¨ˆ</th><th>å¹³å‡</th>
        </tr></thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>

    <!-- è²¯è“„ç®¡ç†è¡¨ -->
    <div class="sec-title">è²¯è“„ç®¡ç†è¡¨ï¼ˆå£åº§æ®‹é«˜ãƒ»å‰æœˆæ¯”ï¼‰</div>
    <div class="sv-bar">
      <div class="fg"><label>å£åº§ãƒ»è³‡ç”£å</label>
        <select id="sv-acct">
          <option value="77bank">ä¸ƒåä¸ƒéŠ€è¡Œ</option>
          <option value="sbi_bank">SBIéŠ€è¡Œ</option>
          <option value="rakuten_bank">æ¥½å¤©éŠ€è¡Œ</option>
          <option value="yucho">ã‚†ã†ã¡ã‚‡éŠ€è¡Œ</option>
          <option value="rakuten_fund">æ¥½å¤©è¨¼åˆ¸ æŠ•è³‡ä¿¡è¨—</option>
          <option value="sbi_fund">SBIè¨¼åˆ¸ æŠ•è³‡ä¿¡è¨—</option>
          <option value="sbi_stock">SBIè¨¼åˆ¸ å›½å†…å€‹åˆ¥æ ª</option>
          <option value="hikiotoshi">å¼•ãè½ã¨ã—</option>
          <option value="azukarikin">é ã‚Šé‡‘</option>
        </select>
      </div>
      <div class="sv-row">
        <div class="fg"><label>è¨˜éŒ²æ—¥</label><input type="date" id="sv-date"></div>
        <div class="fg"><label>æ®‹é«˜ï¼ˆå††ï¼‰</label><input type="number" id="sv-amt" placeholder="0"></div>
      </div>
      <div class="sv-row">
        <div class="fg"><label>å‚™è€ƒ</label><input type="text" id="sv-memo" placeholder=""></div>
        <div class="fg" style="display:flex;align-items:flex-end">
          <button class="btn btn-outline" onclick="addSV()" style="width:100%;padding:.5rem;font-size:.9rem">âœš è¨˜éŒ²</button>
        </div>
      </div>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th style="text-align:left">å£åº§ãƒ»è³‡ç”£</th>
          <th style="text-align:right;font-size:.7rem;color:#aaa">å‰å›</th>
          <th>ï¼”æœˆ</th><th>ï¼•æœˆ</th><th>ï¼–æœˆ</th><th>ï¼—æœˆ</th><th>ï¼˜æœˆ</th><th>ï¼™æœˆ</th>
          <th>ï¼‘ï¼æœˆ</th><th>ï¼‘ï¼‘æœˆ</th><th>ï¼‘ï¼’æœˆ</th><th>ï¼‘æœˆ</th><th>ï¼’æœˆ</th><th>ï¼“æœˆ</th>
        </tr></thead>
        <tbody id="svBody"></tbody>
      </table>
    </div>
  <!-- Excel export at bottom of summary -->
    <div style="margin-top:2rem;padding-top:1.5rem;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:.8rem;align-items:center">
      <button onclick="exportExcel()" style="background:var(--green);color:#fff;border:none;border-radius:8px;padding:.9rem 2.2rem;font-family:var(--font-serif);font-size:1rem;cursor:pointer;letter-spacing:.08em;box-shadow:0 2px 8px rgba(46,107,69,.25);width:100%;max-width:380px">ğŸ“Š Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã™ã‚‹</button>
      <label style="background:#fff;color:var(--ink);border:2px dashed var(--border);border-radius:8px;padding:.85rem 2.2rem;font-family:var(--font-serif);font-size:1rem;cursor:pointer;letter-spacing:.08em;width:100%;max-width:380px;text-align:center;transition:border-color .15s" onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='var(--border)'">
        ğŸ“¥ Excelã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
        <input type="file" accept=".xlsx" onchange="importExcel(event)" style="display:none">
      </label>
      <div style="font-size:.78rem;color:var(--muted);text-align:center">å¾©å…ƒã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼ˆé‡è¤‡é™¤å»ï¼‰</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• ENTRY â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-entry" class="hidden">
    <div class="entry-layout">
      <div class="panel">
        <div class="panel-hdr">åå…¥ãƒ»æ”¯å‡ºã‚’è¨˜éŒ²ã™ã‚‹</div>

        <!-- Step 1 -->
        <div class="step">
          <div class="step-lbl">â‘  ç¨®åˆ¥ã‚’é¸ã¶</div>
          <div class="mode-row">
            <div class="mode-btn" id="btn-exp" onclick="selMode('expense')">
              <span class="icon">ğŸ’¸</span><span class="lbl">æ”¯å‡º</span>
            </div>
            <div class="mode-btn" id="btn-inc" onclick="selMode('income')">
              <span class="icon">ğŸ’´</span><span class="lbl">åå…¥</span>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="step" id="step-cat" style="display:none">
          <div class="step-lbl">â‘¡ ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã¶</div>
          <div class="cat-grid" id="cat-grid"></div>
        </div>

        <!-- Step 3 -->
        <div class="step" id="step-det" style="display:none">
          <div class="step-lbl" id="det-lbl">â‘¢ è©³ç´°ã‚’å…¥åŠ›ã™ã‚‹</div>
          <div class="fields">
            <div class="frow">
              <div class="fg"><label>æ—¥ä»˜</label><input type="date" id="e-date"></div>
              <div class="fg" id="sub-fg"><label>ç¨®åˆ¥</label><select id="e-sub"></select></div>
            </div>
            <div class="fg"><label>é‡‘é¡ï¼ˆå††ï¼‰</label><input type="number" id="e-amt" placeholder="0"></div>
            <div class="fg">
              <label>å‚™è€ƒ</label>
              <input type="text" id="e-memo" placeholder="">
              <div class="memo-candidates" id="memo-chips"></div>
            </div>
            <button class="submit-btn" id="e-sub-btn" onclick="submitEntry()">è¨˜éŒ²ã™ã‚‹</button>
          </div>
        </div>
      </div>

      <div>
        <div class="sec-title">æœ€è¿‘ã®è¨˜éŒ²</div>
        <div class="elist" id="recent-list"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• HISTORY â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-history" class="hidden">
    <div class="fbar">
      <span class="flbl">çµã‚Šè¾¼ã¿ï¼š</span>
      <div class="fp on" onclick="setFil('all',this)">ã™ã¹ã¦</div>
      <div class="fp" onclick="setFil('income',this)">ğŸ’´ åå…¥</div>
      <div class="fp" onclick="setFil('shokuhi',this)">ğŸš é£Ÿè²»</div>
      <div class="fp" onclick="setFil('iryohi',this)">ğŸ’Š åŒ»ç™‚</div>
      <div class="fp" onclick="setFil('gaishoku',this)">ğŸœ å¤–é£Ÿ</div>
      <div class="fp" onclick="setFil('ifuku',this)">ğŸ‘— è¡£æœ</div>
      <div class="fp" onclick="setFil('ryoko',this)">âœˆï¸ æ—…è¡Œ</div>
      <div class="fp" onclick="setFil('seikatsuhi',this)">ğŸ  ç”Ÿæ´»è²»</div>
      <div class="fp" onclick="setFil('teikik',this)">ğŸ”„ å®šæœŸè³¼å…¥</div>
      <div class="fp" onclick="setFil('sonota',this)">ğŸ“¦ ãã®ä»–</div>
    </div>
    <div class="elist" id="hist-list"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• MYCAR SUMMARY â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-mc-summary" class="hidden">
    <div class="stat-grid" id="mc-stat-cards"></div>
    <div class="sec-title">mycar æœˆåˆ¥åæ”¯ä¸€è¦§</div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th style="text-align:left">é …ç›®</th>
          <th>ï¼”æœˆ</th><th>ï¼•æœˆ</th><th>ï¼–æœˆ</th><th>ï¼—æœˆ</th><th>ï¼˜æœˆ</th><th>ï¼™æœˆ</th>
          <th>ï¼‘ï¼æœˆ</th><th>ï¼‘ï¼‘æœˆ</th><th>ï¼‘ï¼’æœˆ</th><th>ï¼‘æœˆ</th><th>ï¼’æœˆ</th><th>ï¼“æœˆ</th>
          <th>è¨ˆ</th>
        </tr></thead>
        <tbody id="mc-sum-body"></tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• MYCAR ENTRY â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-mc-entry" class="hidden">
    <div class="entry-layout">
      <div class="panel">
        <div class="panel-hdr mc">ğŸš— mycaråæ”¯ã‚’è¨˜éŒ²ã™ã‚‹</div>
        <div class="step">
          <div class="step-lbl">â‘  ç¨®åˆ¥ã‚’é¸ã¶</div>
          <div class="cat-grid" style="grid-template-columns:1fr 1fr 1fr">
            <div class="cat-btn mc-cat" onclick="selMcType('income_main',this)"><span class="icon">ğŸ’´</span><span class="lbl">åå…¥ï¼ˆå¤§ï¼‰</span></div>
            <div class="cat-btn mc-cat" onclick="selMcType('income_sub',this)"><span class="icon">ğŸ’´</span><span class="lbl">åå…¥ï¼ˆæ´‹å­ï¼‰</span></div>
            <div class="cat-btn mc-cat" onclick="selMcType('parking',this)"><span class="icon">ğŸ…¿ï¸</span><span class="lbl">é§è»Šå ´ä»£</span></div>
            <div class="cat-btn" onclick="selMcType('gas',this)"><span class="icon">â›½</span><span class="lbl">ã‚¬ã‚½ãƒªãƒ³ä»£</span></div>
            <div class="cat-btn" onclick="selMcType('highway',this)"><span class="icon">ğŸ›£ï¸</span><span class="lbl">é«˜é€Ÿä»£</span></div>
            <div class="cat-btn" onclick="selMcType('other',this)"><span class="icon">ğŸ“</span><span class="lbl">ãã®ä»–</span></div>
          </div>
        </div>
        <div class="step" id="mc-det" style="display:none">
          <div class="step-lbl">â‘¡ è©³ç´°ã‚’å…¥åŠ›ã™ã‚‹</div>
          <div class="fields">
            <div class="frow">
              <div class="fg"><label>æ—¥ä»˜</label><input type="date" id="mc-date"></div>
              <div class="fg"><label>é‡‘é¡ï¼ˆå††ï¼‰</label><input type="number" id="mc-amt" placeholder="0"></div>
            </div>
            <div class="fg">
              <label>å‚™è€ƒ</label>
              <input type="text" id="mc-memo" placeholder="">
              <div class="memo-candidates" id="mc-chips"></div>
            </div>
            <div id="mc-gas-f" style="display:none">
              <div class="frow" style="margin-top:.2rem">
                <div class="fg"><label>ã‚¬ã‚½ãƒªãƒ³é‡ï¼ˆâ„“ï¼‰</label><input type="number" id="mc-liter" step="0.01"></div>
                <div class="fg"><label>å˜ä¾¡ï¼ˆå††/â„“ï¼‰</label><input type="number" id="mc-price"></div>
              </div>
            </div>
            <button class="submit-btn mc-sub" id="mc-btn" onclick="submitMc()">è¨˜éŒ²ã™ã‚‹</button>
          </div>
        </div>
      </div>
      <div>
        <div class="sec-title">æœ€è¿‘ã®mycarè¨˜éŒ²</div>
        <div class="elist" id="mc-recent"></div>

        <!-- é›†è¨ˆãƒ»å±¥æ­´ã¸ã®ãƒ†ã‚­ã‚¹ãƒˆãƒªãƒ³ã‚¯ -->
        <div class="mc-sublinks">
          <span onclick="showMcSub('summary')" id="mclink-summary">ğŸ“Š é›†è¨ˆã‚’è¦‹ã‚‹</span>
          <span class="mc-sublinks-sep">ï½œ</span>
          <span onclick="showMcSub('history')" id="mclink-history">ğŸ“– å±¥æ­´ã‚’è¦‹ã‚‹</span>
        </div>

        <!-- æŠ˜ã‚ŠãŸãŸã¿: é›†è¨ˆ -->
        <div id="mc-sub-summary" class="mc-sub-panel hidden">
          <div class="mc-sub-panel-hdr">
            <span>mycar æœˆåˆ¥é›†è¨ˆ</span>
            <button onclick="hideMcSub('summary')">âœ• é–‰ã˜ã‚‹</button>
          </div>
          <div class="tbl-wrap" style="margin-bottom:0">
            <table>
              <thead><tr>
                <th style="text-align:left">é …ç›®</th>
                <th>ï¼”æœˆ</th><th>ï¼•æœˆ</th><th>ï¼–æœˆ</th><th>ï¼—æœˆ</th><th>ï¼˜æœˆ</th><th>ï¼™æœˆ</th>
                <th>ï¼‘ï¼æœˆ</th><th>ï¼‘ï¼‘æœˆ</th><th>ï¼‘ï¼’æœˆ</th><th>ï¼‘æœˆ</th><th>ï¼’æœˆ</th><th>ï¼“æœˆ</th>
                <th>è¨ˆ</th>
              </tr></thead>
              <tbody id="mc-sum-body2"></tbody>
            </table>
          </div>
        </div>

        <!-- æŠ˜ã‚ŠãŸãŸã¿: å±¥æ­´ -->
        <div id="mc-sub-history" class="mc-sub-panel hidden">
          <div class="mc-sub-panel-hdr">
            <span>mycar å±¥æ­´</span>
            <button onclick="hideMcSub('history')">âœ• é–‰ã˜ã‚‹</button>
          </div>
          <div class="fbar" style="margin-bottom:.6rem">
            <span class="flbl">çµã‚Šè¾¼ã¿ï¼š</span>
            <div class="fp on" onclick="setMcFil('all',this)">ã™ã¹ã¦</div>
            <div class="fp" onclick="setMcFil('income_main',this)">åå…¥ï¼ˆå¤§ï¼‰</div>
            <div class="fp" onclick="setMcFil('income_sub',this)">åå…¥ï¼ˆæ´‹å­ï¼‰</div>
            <div class="fp" onclick="setMcFil('parking',this)">é§è»Šå ´</div>
            <div class="fp" onclick="setMcFil('gas',this)">ã‚¬ã‚½ãƒªãƒ³</div>
            <div class="fp" onclick="setMcFil('highway',this)">é«˜é€Ÿ</div>
            <div class="fp" onclick="setMcFil('other',this)">ãã®ä»–</div>
          </div>
          <div class="elist" id="mc-hist"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- mc-summary page kept as alias (not in nav but showTab still works) -->
  <div id="page-mc-summary" class="hidden"></div>
  <div id="page-mc-history" class="hidden"></div>

</div><!-- /main -->

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG & CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS = ['ï¼”æœˆ','ï¼•æœˆ','ï¼–æœˆ','ï¼—æœˆ','ï¼˜æœˆ','ï¼™æœˆ','ï¼‘ï¼æœˆ','ï¼‘ï¼‘æœˆ','ï¼‘ï¼’æœˆ','ï¼‘æœˆ','ï¼’æœˆ','ï¼“æœˆ'];
const FIXED_SEIKATSUHI = 0;
const FIXED_HOKEN = 0;

// ã‚«ãƒ†ã‚´ãƒªå®šç¾©
const EXP_CATS = [
  { key:'seikatsuhi', icon:'ğŸ ', label:'ç”Ÿæ´»è²»',
    subs:[{v:'seikatsuhi',l:'ç”Ÿæ´»è²»'}],
    chips:['é£Ÿæ–™å“','æ—¥ç”¨å“','å…‰ç†±è²»','å®¶è³ƒ','æ°´é“','é›»æ°—','ã‚¬ã‚¹'] },
  { key:'shokuhi',  icon:'ğŸš', label:'é£Ÿè²»',
    subs:[{v:'food',l:'é£Ÿå“ä»£'},{v:'alcohol',l:'é…’ä»£'},{v:'furusato',l:'ãµã‚‹ã•ã¨ç´ç¨'}],
    chips:['ãƒ¢ãƒŠãƒ¢ãƒŠ','ãƒ¨ãƒ¼ã‚¯','æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼','ã‚³ãƒ¼ãƒ—'] },
  { key:'iryohi',   icon:'ğŸ’Š', label:'åŒ»ç™‚ãƒ»è¡›ç”Ÿè²»',
    subs:[{v:'beauty',l:'ç†å®¹ç¾å®¹ä»£'},{v:'medical',l:'è–¬ãƒ»æ²»ç™‚ä»£'},{v:'cleaning',l:'ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ä»£'},{v:'daily',l:'ãã®ä»–ç”Ÿæ´»ç”¨å“'}],
    chips:['ã‚¯ãƒ©ãƒ©ãƒ³','ã‚¢ãƒ©ã‚»ãƒŠS','ãƒãƒ¼ãƒ•ãƒ ãƒ¼ãƒ³','ã‚¸ãƒ¬ãƒƒãƒˆæ›¿ãˆåˆƒ'] },
  { key:'gaishoku', icon:'ğŸœ', label:'å¤–é£Ÿè²»',
    subs:[{v:'gaishoku',l:'å¤–é£Ÿ'}],
    chips:['ä¸²é³¥','çŸ³åºŠ','å®æˆ¸','ã‚«ãƒ•ã‚§ãƒ‰ãƒªãƒ¥ãƒ¼ãƒãƒ³','ãƒ©ãƒ³ãƒ'] },
  { key:'ifuku',    icon:'ğŸ‘—', label:'è¡£æœ',
    subs:[{v:'ifuku',l:'è¡£æœ'}],
    chips:['Tã‚·ãƒ£ãƒ„','ã‚·ãƒ£ãƒ„','ã‚ºãƒœãƒ³','ä¸‹ç€','é´','ã‚³ãƒ¼ãƒˆ'] },
  { key:'ryoko',    icon:'âœˆï¸', label:'æ—…è¡Œ',
    subs:[{v:'ryoko',l:'æ—…è¡Œ'}],
    chips:['ä¹å·æ—…è¡Œ','åŒ—æµ·é“æ—…è¡Œ','æ±åŒ—æ—…è¡Œ','ãƒ›ãƒ†ãƒ«','äº¤é€šè²»'] },
  { key:'teikik',   icon:'ğŸ”„', label:'å®šæœŸè³¼å…¥',
    subs:[{v:'hoken',l:'ä¿é™º'},{v:'zeikin',l:'ç¨é‡‘'},{v:'teiki',l:'å®šæœŸè³¼å…¥'}],
    chips:['è‡ªå‹•è»Šä¿é™º','ç”Ÿå‘½ä¿é™º','å›ºå®šè³‡ç”£ç¨','ä½æ°‘ç¨','NHK','ã‚µãƒ–ã‚¹ã‚¯'] },
  { key:'sonota',   icon:'ğŸ“¦', label:'ãã®ä»–',
    subs:[{v:'other',l:'ãã®ä»–'},{v:'book',l:'æœ¬'}],
    chips:['å›ºå®šè³‡ç”£ç¨','Audible','Suicaã‚ªãƒ¼ãƒˆãƒãƒ£ãƒ¼ã‚¸','æ¥½å¤©PAYæœˆè¨ˆ','è‡ªè»¢è»Šä¿é™º','æ¯ã®æ—¥','çˆ¶ã®æ—¥'] },
];
const INC_CATS = [
  { key:'income', icon:'ğŸ’°', label:'çµ¦ä¸',   subs:[{v:'salary',l:'çµ¦ä¸'}],   chips:[] },
  { key:'income', icon:'ğŸ', label:'è³ä¸ç­‰', subs:[{v:'bonus',l:'è³ä¸ç­‰'}],  chips:[] },
  { key:'income', icon:'ğŸ“ˆ', label:'é…å½“ç­‰', subs:[{v:'dividend',l:'é…å½“ç­‰'}],chips:[] },
];

const TL = {
  salary:'çµ¦ä¸', bonus:'è³ä¸ç­‰', dividend:'é…å½“ç­‰',
  food:'é£Ÿå“ä»£', alcohol:'é…’ä»£', furusato:'ãµã‚‹ã•ã¨ç´ç¨',
  beauty:'ç†å®¹ç¾å®¹ä»£', medical:'è–¬ãƒ»æ²»ç™‚ä»£', cleaning:'ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ä»£', daily:'ãã®ä»–ç”Ÿæ´»ç”¨å“',
  seikatsuhi:'ç”Ÿæ´»è²»', gaishoku:'å¤–é£Ÿ', ifuku:'è¡£æœ', ryoko:'æ—…è¡Œ', hoken:'ä¿é™º', zeikin:'ç¨é‡‘', teiki:'å®šæœŸè³¼å…¥', other:'ãã®ä»–', book:'æœ¬',
  income_main:'åå…¥ï¼ˆå¤§ï¼‰', income_sub:'åå…¥ï¼ˆæ´‹å­ï¼‰', parking:'é§è»Šå ´ä»£', gas:'ã‚¬ã‚½ãƒªãƒ³ä»£', highway:'é«˜é€Ÿä»£',
};
const CL = { income:'åå…¥', seikatsuhi:'ç”Ÿæ´»è²»', shokuhi:'é£Ÿè²»', iryohi:'åŒ»ç™‚ãƒ»è¡›ç”Ÿè²»', gaishoku:'å¤–é£Ÿè²»', ifuku:'è¡£æœ', ryoko:'æ—…è¡Œ', teikik:'å®šæœŸè³¼å…¥', sonota:'ãã®ä»–', mycar:'mycar' };

const MC_CHIPS = {
  income_main:[], income_sub:[], parking:['æœˆæ¥µé§è»Šå ´'],
  gas:['ã‚³ã‚¹ãƒ¢','ã‚¨ãƒã‚ªã‚¹','å‡ºå…‰'], highway:['æ±åŒ—é“','ä»™å°å—','ä»™å°åŒ—'],
  other:['ä¿é™º','ã‚¿ã‚¤ãƒ¤äº¤æ›','è»Šæ¤œ','æ´—è»Š','ä¿®ç†'],
};

const SV_ACCOUNTS = [
  {key:'77bank',l:'ä¸ƒåä¸ƒéŠ€è¡Œ'},{key:'sbi_bank',l:'SBIéŠ€è¡Œ'},{key:'rakuten_bank',l:'æ¥½å¤©éŠ€è¡Œ'},
  {key:'yucho',l:'ã‚†ã†ã¡ã‚‡éŠ€è¡Œ'},{key:'rakuten_fund',l:'æ¥½å¤©è¨¼åˆ¸ æŠ•è³‡ä¿¡è¨—'},
  {key:'sbi_fund',l:'SBIè¨¼åˆ¸ æŠ•è³‡ä¿¡è¨—'},{key:'sbi_stock',l:'SBIè¨¼åˆ¸ å›½å†…å€‹åˆ¥æ ª'},
  {key:'hikiotoshi',l:'å¼•ãè½ã¨ã—'},{key:'azukarikin',l:'é ã‚Šé‡‘'},
];
const DEDUCT = ['hikiotoshi','azukarikin'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let FY = 2025;
let eMode = null, eCat = null, eSubtype = null;
let mcType = null;
let histFil = 'all', mcHistFil = 'all';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const K = cat => `kb_${FY}_${cat}`;
const loadD = cat => { try { return JSON.parse(localStorage.getItem(K(cat)) || '[]'); } catch { return []; } };
const saveD = (cat,d) => localStorage.setItem(K(cat), JSON.stringify(d));
const loadSV = () => { try { return JSON.parse(localStorage.getItem(`kb_sv_${FY}`) || '{}'); } catch { return {}; } };
const saveSV = d => localStorage.setItem(`kb_sv_${FY}`, JSON.stringify(d));

// â”€â”€ 21æ—¥å§‹ã¾ã‚Šã®æœˆåˆ¤å®š â”€â”€
// 4/21ã€œ5/20 â†’ 4æœˆåˆ†(index 0), 5/21ã€œ6/20 â†’ 5æœˆåˆ†(index 1), ...
// 3/21ã€œ4/20 â†’ 3æœˆåˆ†(index 11)
function getFiscalPeriod(dateStr) {
  const d = new Date(dateStr);
  const day = d.getDate();
  let month = d.getMonth() + 1; // 1-12
  let year = d.getFullYear();
  // 21æ—¥ä»¥é™ã¯å½“æœˆåˆ†ã€20æ—¥ä»¥å‰ã¯å‰æœˆåˆ†
  if (day <= 20) {
    month -= 1;
    if (month === 0) { month = 12; year -= 1; }
  }
  // å¹´åº¦åˆ¤å®šï¼ˆ4æœˆåˆ†ã€œ3æœˆåˆ†ï¼‰
  const fy = month >= 4 ? year : year - 1;
  // fiscal month index: 4æœˆ=0, 5æœˆ=1, ..., 3æœˆ=11
  const fmi = month >= 4 ? month - 4 : month + 8;
  return { fy, fmi };
}

function isFY(dateStr) { return getFiscalPeriod(dateStr).fy === FY; }
function getFMI(dateStr) { return getFiscalPeriod(dateStr).fmi; }

const today = () => new Date().toISOString().slice(0,10);
const fmt = n => n != null ? n.toLocaleString('ja-JP') : 'â€”';

function mTotals(cat) {
  const t = new Array(12).fill(0);
  loadD(cat).filter(e => isFY(e.date)).forEach(e => { t[getFMI(e.date)] += +e.amount || 0; });
  return t;
}
function mByType(cat, type) {
  const t = new Array(12).fill(0);
  loadD(cat).filter(e => isFY(e.date) && e.type === type).forEach(e => { t[getFMI(e.date)] += +e.amount || 0; });
  return t;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  // Year selector: 2025â€“2030
  const sel = document.getElementById('yrSel');
  for (let y = 2025; y <= 2030; y++) {
    const o = document.createElement('option');
    o.value = y; o.textContent = `ä»¤å’Œ${y-2018}å¹´åº¦ï¼ˆ${y}ï¼‰`;
    if (y === FY) o.selected = true;
    sel.appendChild(o);
  }
  initDates();
  renderAll();
});

function changeYear(y) {
  FY = parseInt(y);
  renderAll();
}

function initDates() {
  document.querySelectorAll('input[type="date"]').forEach(el => el.value = today());
}

function renderAll() {
  renderSummary();
  renderSavingsTable();
  renderRecent();
  renderHistory();
  renderMcSummary();
  renderMcRecent();
  renderMcHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(tab) {
  document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById(`page-${tab}`).classList.remove('hidden');
  document.getElementById(`tab-${tab}`).classList.add('active');
  const renders = {
    'summary': () => { renderSummary(); renderSavingsTable(); },
    'entry': renderRecent,
    'history': renderHistory,
    'mc-entry': renderMcRecent,
    'mc-summary': ()=>{},
    'mc-history': ()=>{},
  };
  if (renders[tab]) renders[tab]();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary() {
  const sal=mByType('income','salary'), bon=mByType('income','bonus'), div=mByType('income','dividend');
  const inc=sal.map((v,i)=>v+bon[i]+div[i]);
  const sh=mTotals('shokuhi'), ir=mTotals('iryohi'), gs=mTotals('gaishoku');
  const if_=mTotals('ifuku'), ry=mTotals('ryoko'), tk=mTotals('teikik'), sn=mTotals('sonota');
  const sei=mTotals('seikatsuhi');
  const exp=sei.map((v,i)=>v+sh[i]+ir[i]+gs[i]+if_[i]+ry[i]+tk[i]+sn[i]);
  const sav=inc.map((v,i)=>v-exp[i]);
  const tI=inc.reduce((a,b)=>a+b,0), tE=exp.reduce((a,b)=>a+b,0), tS=tI-tE;
  const em=inc.filter(v=>v>0).length||1;

  document.getElementById('statCards').innerHTML=`
    <div class="stat-card inc"><div class="stat-lbl">å¹´é–“åå…¥è¨ˆ</div><div class="stat-val">${fmt(tI)}</div><div class="stat-sub">æœˆå¹³å‡ ${fmt(Math.round(tI/em))}</div></div>
    <div class="stat-card exp"><div class="stat-lbl">å¹´é–“æ”¯å‡ºè¨ˆ</div><div class="stat-val neg">${fmt(tE)}</div><div class="stat-sub">æœˆå¹³å‡ ${fmt(Math.round(tE/12))}</div></div>
    <div class="stat-card sav"><div class="stat-lbl">åç›®è²¯è“„é¡</div><div class="stat-val ${tS>=0?'pos':'neg'}">${fmt(tS)}</div><div class="stat-sub">åå…¥ âˆ’ æ”¯å‡º</div></div>`;

  const row=(k,n,d)=>{const t=d.reduce((a,b)=>a+b,0),m=d.filter(v=>v>0).length||1;return`<tr><td>${k}</td><td>${n}</td>${d.map(v=>`<td class="${v<0?'neg':''}">${v?fmt(v):'â€”'}</td>`).join('')}<td>${fmt(t)}</td><td>${fmt(Math.round(t/m))}</td></tr>`;};
  const sub=(l,d)=>{const t=d.reduce((a,b)=>a+b,0);return`<tr class="sub"><td></td><td>${l}</td>${d.map(v=>`<td>${fmt(v)}</td>`).join('')}<td>${fmt(t)}</td><td>${fmt(Math.round(t/12))}</td></tr>`;};
  const tr=(l,d,c)=>{const t=d.reduce((a,b)=>a+b,0);return`<tr class="${c}"><td colspan="2">${l}</td>${d.map(v=>`<td class="${v<0?'neg':''}">${fmt(v)}</td>`).join('')}<td>${fmt(t)}</td><td></td></tr>`;};
  let c=0; const cum=sav.map(v=>{c+=v;return c;});
  document.getElementById('summaryBody').innerHTML=
    row('åå…¥','çµ¦ä¸',sal)+row('','è³ä¸ç­‰',bon)+row('','é…å½“ç­‰',div)+sub('åå…¥ã€€è¨ˆ',inc)+
    row('æ”¯å‡º','ç”Ÿæ´»è²»',sei)+row('','é£Ÿè²»',sh)+row('','åŒ»ç™‚ãƒ»è¡›ç”Ÿè²»',ir)+row('','å¤–é£Ÿè²»',gs)+
    row('','è¡£æœ',if_)+row('','æ—…è¡Œ',ry)+row('','å®šæœŸè³¼å…¥',tk)+row('','ãã®ä»–',sn)+
    sub('æ”¯å‡ºã€€è¨ˆ',exp)+tr('åç›®è²¯è“„é¡',sav,'sav-row')+tr('åç›®è²¯è“„é¡ã€€ç´¯è¨ˆ',cum,'sav-row');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVINGS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addSV() {
  const date=document.getElementById('sv-date').value;
  const acct=document.getElementById('sv-acct').value;
  const amt=parseFloat(document.getElementById('sv-amt').value);
  const memo=document.getElementById('sv-memo').value;
  if (!date||isNaN(amt)){showToast('æ—¥ä»˜ã¨æ®‹é«˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  const d=loadSV(); if (!d[acct]) d[acct]={};
  d[acct][getFMI(date)]={amount:amt,memo:memo?`ï¼ˆ${memo}ï¼‰`:'',date};
  saveSV(d);
  document.getElementById('sv-amt').value='';
  document.getElementById('sv-memo').value='';
  renderSavingsTable(); showToast('è²¯è“„ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
}

function renderSavingsTable() {
  const data=loadSV(), body=document.getElementById('svBody');
  if (!body) return;
  let html='', mt=new Array(12).fill(null);
  SV_ACCOUNTS.forEach(({key,l})=>{
    const ac=data[key]||{}, isDed=DEDUCT.includes(key);
    const cells=[];
    for (let i=0;i<12;i++){
      const r=ac[i], v=r?r.amount:null;
      const ms=r&&r.memo?`<br><span style="font-size:.68rem;color:var(--muted)">${r.memo}</span>`:'';
      const del=r?`<span onclick="delSV('${key}',${i})" style="cursor:pointer;color:var(--border);margin-left:3px;font-size:.72rem">âœ•</span>`:'';
      cells.push(`<td>${v!=null?fmt(v)+ms+del:'â€”'}</td>`);
      if (v!=null){if(mt[i]===null)mt[i]=0; mt[i]+=isDed?-v:v;}
    }
    html+=`<tr><td style="text-align:left">${l}${isDed?'<span style="color:var(--red);font-size:.68rem;margin-left:3px">ï¼ˆæ§é™¤ï¼‰</span>':''}</td><td style="text-align:right;color:var(--muted)">â€”</td>${cells.join('')}</tr>`;
  });
  html+=`<tr class="sv-total"><td style="text-align:left">åˆè¨ˆ</td><td>â€”</td>${mt.map(v=>`<td>${v!=null?fmt(v):'â€”'}</td>`).join('')}</tr>`;
  const dc=mt.map((v,i)=>{const p=i===0?null:mt[i-1];if(v===null||p===null)return'<td>â€”</td>';const d=v-p;return`<td class="${d>=0?'c-pos':'c-neg'}">${d>=0?'+':''}${fmt(d)}</td>`;}).join('');
  html+=`<tr class="sv-diff"><td style="text-align:left">è²¯è“„ã€€å‰æœˆæ¯”</td><td>â€”</td>${dc}</tr>`;
  let cum=0;
  const cc=mt.map((v,i)=>{const p=i===0?null:mt[i-1];if(v===null||p===null)return'<td>â€”</td>';cum+=v-p;return`<td>${fmt(cum)}</td>`;}).join('');
  html+=`<tr class="sv-cum"><td style="text-align:left">è²¯è“„ã€€å¹´ç´¯è¨ˆ</td><td>â€”</td>${cc}</tr>`;
  body.innerHTML=html;
}
function delSV(key,fm){const d=loadSV();if(d[key])delete d[key][fm];saveSV(d);renderSavingsTable();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRY PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selMode(mode) {
  eMode=mode; eCat=null; eSubtype=null;
  document.getElementById('btn-exp').className='mode-btn'+(mode==='expense'?' sel-exp':'');
  document.getElementById('btn-inc').className='mode-btn'+(mode==='income'?' sel-inc':'');
  const cats=mode==='income'?INC_CATS:EXP_CATS;
  const isInc=mode==='income';
  document.getElementById('cat-grid').innerHTML=cats.map((c,i)=>
    `<div class="cat-btn${isInc?' inc-cat':''}" onclick="selCat(${i})">
      <span class="icon">${c.icon}</span><span class="lbl">${c.label}</span>
    </div>`).join('');
  document.getElementById('step-cat').style.display='';
  document.getElementById('step-det').style.display='none';
}

function selCat(idx) {
  const cats=eMode==='income'?INC_CATS:EXP_CATS;
  eCat=cats[idx];
  document.querySelectorAll('#cat-grid .cat-btn').forEach((b,i)=>{
    b.className=`cat-btn${eMode==='income'?' inc-cat':''}${i===idx?' sel':''}`;
  });
  // Subtype
  const subs=eCat.subs;
  const sfg=document.getElementById('sub-fg');
  if (subs.length<=1){sfg.style.display='none';eSubtype=subs[0].v;}
  else {
    sfg.style.display='';
    const sel=document.getElementById('e-sub');
    sel.innerHTML=subs.map(s=>`<option value="${s.v}">${s.l}</option>`).join('');
    eSubtype=subs[0].v;
    sel.onchange=()=>{eSubtype=sel.value;};
  }
  // Memo chips
  renderChips('memo-chips', getUserChips(eCat.key), 'e-memo', eCat.key, eCat.label);
  // Button
  const btn=document.getElementById('e-sub-btn');
  btn.className='submit-btn'+(eMode==='income'?' inc':'');
  btn.textContent=`${eCat.label}ã‚’è¨˜éŒ²ã™ã‚‹`;
  document.getElementById('det-lbl').textContent=`â‘¢ ${eCat.label}ã®è©³ç´°ã‚’å…¥åŠ›`;
  document.getElementById('step-det').style.display='';
  document.getElementById('e-date').value=today();
  document.getElementById('e-amt').value='';
  document.getElementById('e-memo').value='';
  setTimeout(()=>document.getElementById('e-amt').focus(),50);
}

function setMemo(inputId, val) {
  document.getElementById(inputId).value=val;
}

function submitEntry() {
  const date=document.getElementById('e-date').value;
  const amt=parseFloat(document.getElementById('e-amt').value);
  const memo=document.getElementById('e-memo').value;
  if (!date||isNaN(amt)||amt<=0){showToast('æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if (!eCat){showToast('ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„');return;}
  const cat=eMode==='income'?'income':eCat.key;
  const d=loadD(cat);
  d.push({id:Date.now(),date,amount:amt,memo:memo?`ï¼ˆ${memo}ï¼‰`:'',type:eSubtype,mode:eMode,cat});
  d.sort((a,b)=>new Date(a.date)-new Date(b.date));
  saveD(cat,d);
  showToast(`${eCat.label}ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`);
  document.getElementById('e-amt').value='';
  document.getElementById('e-memo').value='';
  document.getElementById('e-date').value=today();
  document.getElementById('e-amt').focus();
  renderRecent();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRY LIST HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAllEntries(filterCat) {
  const cats=['income','seikatsuhi','shokuhi','iryohi','gaishoku','ifuku','ryoko','teikik','sonota'];
  let all=[];
  cats.forEach(cat=>{
    if (filterCat!=='all'&&filterCat!==cat) return;
    loadD(cat).filter(e=>isFY(e.date)).forEach(e=>all.push({...e,cat}));
  });
  return all.sort((a,b)=>new Date(b.date)-new Date(a.date));
}

function renderRecent() {
  renderEList('recent-list', getAllEntries('all').slice(0,40), false);
}

function renderHistory() {
  renderEList('hist-list', getAllEntries(histFil), true);
}

function renderEList(id, entries, grouped) {
  const el=document.getElementById(id);
  if (!entries.length){el.innerHTML=`<div class="empty"><span class="icon">ğŸ“„</span><p>è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;return;}
  if (!grouped){el.innerHTML=entries.map(e=>eHtml(e)).join('');return;}
  const groups={};
  entries.forEach(e=>{const fm=getFMI(e.date);if(!groups[fm])groups[fm]=[];groups[fm].push(e);});
  let html='';
  Object.keys(groups).sort((a,b)=>b-a).forEach(fm=>{
    const list=groups[fm];
    const tI=list.filter(e=>e.cat==='income').reduce((s,e)=>s+e.amount,0);
    const tE=list.filter(e=>e.cat!=='income').reduce((s,e)=>s+e.amount,0);
    html+=`<div style="border-bottom:1px solid var(--border)">
      <div class="mhdr"><span>${MONTHS[fm]}</span><span class="mttl">åå…¥ +${fmt(tI)} / æ”¯å‡º âˆ’${fmt(tE)}</span></div>
      ${list.map(e=>eHtml(e)).join('')}
    </div>`;
  });
  el.innerHTML=html;
}

function eHtml(e) {
  const isInc=e.cat==='income';
  const catL=CL[e.cat]||'';
  const typeL=TL[e.type]||e.type||'';
  const label=typeL&&typeL!==catL?typeL:catL;
  return`<div class="ei">
    <span class="edate">${e.date.slice(5)}</span>
    <span class="ebadge ${isInc?'b-inc':'b-exp'}">${catL}</span>
    <span class="etext">${label}${e.memo?'ã€€'+e.memo:''}</span>
    <span class="eamt ${isInc?'inc-c':''}">${isInc?'+':''}Â¥${fmt(e.amount)}</span>
    <button class="edel" onclick="delEntry('${e.cat}',${e.id})">âœ•</button>
  </div>`;
}

function delEntry(cat,id){
  saveD(cat,loadD(cat).filter(e=>e.id!==id));
  renderRecent(); renderHistory(); renderSummary();
  showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

function setFil(f,btn){
  histFil=f;
  document.querySelectorAll('#page-history .fp').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MYCAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selMcType(type, btn) {
  mcType=type;
  document.querySelectorAll('#page-mc-entry .cat-btn').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  document.getElementById('mc-det').style.display='';
  document.getElementById('mc-date').value=today();
  document.getElementById('mc-amt').value='';
  document.getElementById('mc-memo').value='';
  document.getElementById('mc-gas-f').style.display=type==='gas'?'':'none';
  // Chips
  renderChips('mc-chips', getUserChips('mc_'+type), 'mc-memo', 'mc_'+type, TL[type]||type);
  const isInc=['income_main','income_sub'].includes(type);
  document.getElementById('mc-btn').className='submit-btn'+(isInc?' mc-sub':' mc-sub');
  setTimeout(()=>document.getElementById('mc-amt').focus(),50);
}

function submitMc() {
  const date=document.getElementById('mc-date').value;
  const amt=parseFloat(document.getElementById('mc-amt').value);
  const memo=document.getElementById('mc-memo').value;
  if (!date||isNaN(amt)){showToast('æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  if (!mcType){showToast('ç¨®åˆ¥ã‚’é¸ã‚“ã§ãã ã•ã„');return;}
  const isInc=['income_main','income_sub'].includes(mcType);
  const e={id:Date.now(),date,amount:amt,memo:memo?`ï¼ˆ${memo}ï¼‰`:'',type:mcType,mode:isInc?'income':'expense',cat:'mycar'};
  if (mcType==='gas'){
    e.gasLiter=parseFloat(document.getElementById('mc-liter').value)||null;
    e.gasPrice=parseFloat(document.getElementById('mc-price').value)||null;
  }
  const d=loadD('mycar'); d.push(e); d.sort((a,b)=>new Date(a.date)-new Date(b.date)); saveD('mycar',d);
  showToast('mycaråæ”¯ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ');
  document.getElementById('mc-amt').value='';
  document.getElementById('mc-memo').value='';
  if (mcType==='gas'){document.getElementById('mc-liter').value='';document.getElementById('mc-price').value='';}
  renderMcRecent(); renderMcSummary();
}

function renderMcSummary() {
  const data=loadD('mycar').filter(e=>isFY(e.date));
  const mcTypes=['income_main','income_sub','parking','gas','highway','other'];
  const mt={};
  mcTypes.forEach(t=>{mt[t]=new Array(12).fill(0);});
  data.forEach(e=>{if(mt[e.type])mt[e.type][getFMI(e.date)]+=+e.amount||0;});
  const totInc=mt.income_main.map((v,i)=>v+mt.income_sub[i]);
  const totExp=mt.parking.map((v,i)=>v+mt.gas[i]+mt.highway[i]+mt.other[i]);
  const tI=totInc.reduce((a,b)=>a+b,0), tE=totExp.reduce((a,b)=>a+b,0);
  document.getElementById('mc-stat-cards').innerHTML=`
    <div class="stat-card inc"><div class="stat-lbl">mycaråå…¥è¨ˆ</div><div class="stat-val">${fmt(tI)}</div></div>
    <div class="stat-card exp"><div class="stat-lbl">mycaræ”¯å‡ºè¨ˆ</div><div class="stat-val neg">${fmt(tE)}</div></div>
    <div class="stat-card sav"><div class="stat-lbl">mycaråæ”¯</div><div class="stat-val ${tI-tE>=0?'pos':'neg'}">${fmt(tI-tE)}</div></div>`;
  const row=(l,d)=>{const t=d.reduce((a,b)=>a+b,0);return`<tr><td>${l}</td>${d.map(v=>`<td>${v?fmt(v):'â€”'}</td>`).join('')}<td>${fmt(t)}</td></tr>`;};
  const sub=(l,d)=>{const t=d.reduce((a,b)=>a+b,0);return`<tr class="sub"><td>${l}</td>${d.map(v=>`<td>${fmt(v)}</td>`).join('')}<td>${fmt(t)}</td></tr>`;};
  document.getElementById('mc-sum-body').innerHTML=
    row('åå…¥ï¼ˆå¤§ï¼‰',mt.income_main)+row('åå…¥ï¼ˆæ´‹å­ï¼‰',mt.income_sub)+sub('åå…¥ã€€è¨ˆ',totInc)+
    row('é§è»Šå ´ä»£',mt.parking)+row('ã‚¬ã‚½ãƒªãƒ³ä»£',mt.gas)+row('é«˜é€Ÿä»£',mt.highway)+row('ãã®ä»–',mt.other)+sub('æ”¯å‡ºã€€è¨ˆ',totExp);
}

function getMcEntries(filterType) {
  return loadD('mycar').filter(e=>isFY(e.date)&&(filterType==='all'||e.type===filterType))
    .sort((a,b)=>new Date(b.date)-new Date(a.date));
}

function renderMcRecent() {
  renderMcList('mc-recent', getMcEntries('all').slice(0,40));
}

function renderMcHistory() {
  renderMcList('mc-hist', getMcEntries(mcHistFil));
}

function renderMcList(id, entries) {
  const el=document.getElementById(id);
  if (!entries.length){el.innerHTML=`<div class="empty"><span class="icon">ğŸš—</span><p>è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;return;}
  const groups={};
  entries.forEach(e=>{const fm=getFMI(e.date);if(!groups[fm])groups[fm]=[];groups[fm].push(e);});
  let html='';
  Object.keys(groups).sort((a,b)=>b-a).forEach(fm=>{
    const list=groups[fm];
    const tot=list.reduce((s,e)=>s+e.amount,0);
    html+=`<div style="border-bottom:1px solid var(--border)">
      <div class="mhdr"><span>${MONTHS[fm]}</span><span class="mttl">Â¥${fmt(tot)}</span></div>
      ${list.map(e=>{
        const isInc=['income_main','income_sub'].includes(e.type);
        const gas=e.gasLiter?`ã€€${e.gasLiter}â„“`:'';
        return`<div class="ei">
          <span class="edate">${e.date.slice(5)}</span>
          <span class="ebadge b-mc">mycar</span>
          <span class="etext">${TL[e.type]||e.type}${gas}${e.memo?'ã€€'+e.memo:''}</span>
          <span class="eamt ${isInc?'inc-c':''}">${isInc?'+':''}Â¥${fmt(e.amount)}</span>
          <button class="edel" onclick="delMc(${e.id})">âœ•</button>
        </div>`;
      }).join('')}
    </div>`;
  });
  el.innerHTML=html;
}

function delMc(id){saveD('mycar',loadD('mycar').filter(e=>e.id!==id));renderMcRecent();renderMcSummary();renderMcHistory();showToast('å‰Šé™¤ã—ã¾ã—ãŸ');}

function setMcFil(f,btn){
  mcHistFil=f;
  document.querySelectorAll('#page-mc-history .fp').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  renderMcHistory();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportExcel(){
  const wb=XLSX.utils.book_new(), M=MONTHS;
  const sal=mByType('income','salary'), bon=mByType('income','bonus'), div=mByType('income','dividend');
  const inc=sal.map((v,i)=>v+bon[i]+div[i]);
  const sh=mTotals('shokuhi'), ir=mTotals('iryohi'), gs=mTotals('gaishoku');
  const if_=mTotals('ifuku'), ry=mTotals('ryoko'), tk=mTotals('teikik'), sn=mTotals('sonota');
  const sei=mTotals('seikatsuhi');
  const exp=sei.map((v,i)=>v+sh[i]+ir[i]+gs[i]+if_[i]+ry[i]+tk[i]+sn[i]);
  const sav=inc.map((v,i)=>v-exp[i]);
  let c=0; const cum=sav.map(v=>{c+=v;return c;});
  const hdr=['åŒºåˆ†','é …ç›®',...M,'è¨ˆ','å¹³å‡'];
  const mkR=(k,n,d)=>{const t=d.reduce((a,b)=>a+b,0),m=d.filter(v=>v>0).length||1;return[k,n,...d,t,Math.round(t/m)];};
  const aoa=[[`ä»¤å’Œ${FY-2018}å¹´åº¦ã€€å®¶è¨ˆç°¿`],[],hdr,
    mkR('åå…¥','çµ¦ä¸',sal),mkR('','è³ä¸ç­‰',bon),mkR('','é…å½“ç­‰',div),mkR('','åå…¥ è¨ˆ',inc),
    mkR('æ”¯å‡º','ç”Ÿæ´»è²»',sei),mkR('','é£Ÿè²»',sh),mkR('','åŒ»ç™‚ãƒ»è¡›ç”Ÿè²»',ir),mkR('','å¤–é£Ÿè²»',gs),
    mkR('','è¡£æœ',if_),mkR('','æ—…è¡Œ',ry),mkR('','å®šæœŸè³¼å…¥',tk),mkR('','ãã®ä»–',sn),
    mkR('','æ”¯å‡º è¨ˆ',exp),
    ['åç›®è²¯è“„é¡','',...sav,sav.reduce((a,b)=>a+b,0)],
    ['åç›®è²¯è“„é¡ã€€ç´¯è¨ˆ','',...cum],[],
    ['è²¯è“„ç®¡ç†è¡¨'],[], ['å£åº§ãƒ»è³‡ç”£','å‰å›',...M],
  ];
  const svd=loadSV(); let mt=new Array(12).fill(null);
  SV_ACCOUNTS.forEach(({key,l})=>{
    const ac=svd[key]||{},isDed=DEDUCT.includes(key);
    const row=[l+(isDed?'ï¼ˆæ§é™¤ï¼‰':''),''];
    for(let i=0;i<12;i++){const r=ac[i],v=r?r.amount:null;row.push(v!=null?v:'');if(v!=null){if(mt[i]===null)mt[i]=0;mt[i]+=isDed?-v:v;}}
    aoa.push(row);
  });
  aoa.push(['åˆè¨ˆ','',...mt.map(v=>v!=null?v:'')]);
  const dr=['è²¯è“„ã€€å‰æœˆæ¯”',''];mt.forEach((v,i)=>{const p=i===0?null:mt[i-1];dr.push(v!=null&&p!=null?v-p:'');});aoa.push(dr);
  let c2=0;const cr=['è²¯è“„ã€€å¹´ç´¯è¨ˆ',''];mt.forEach((v,i)=>{const p=i===0?null:mt[i-1];if(v!=null&&p!=null){c2+=v-p;cr.push(c2);}else cr.push('');});aoa.push(cr);
  const ws1=XLSX.utils.aoa_to_sheet(aoa);
  ws1['!cols']=[{wch:14},{wch:14},...M.map(()=>({wch:11})),{wch:12},{wch:10}];
  XLSX.utils.book_append_sheet(wb,ws1,'ç·åˆ');

  // é£Ÿè²»
  const shd=loadD('shokuhi');
  const s2=[['é£Ÿè²»å†…è¨³è¡¨'],[],['æœˆæ—¥','é£Ÿå“ä»£','é…’ä»£','ãµã‚‹ã•ã¨ç´ç¨','åˆè¨ˆ','å‚™è€ƒ']];
  shd.filter(e=>isFY(e.date)).forEach(e=>s2.push([e.date,e.type==='food'?e.amount:null,e.type==='alcohol'?e.amount:null,e.type==='furusato'?e.amount:null,e.amount,e.memo]));
  for(let i=0;i<12;i++){const es=shd.filter(e=>isFY(e.date)&&getFMI(e.date)===i);const f=es.filter(e=>e.type==='food').reduce((a,e)=>a+e.amount,0),a=es.filter(e=>e.type==='alcohol').reduce((a,e)=>a+e.amount,0),fu=es.filter(e=>e.type==='furusato').reduce((a,e)=>a+e.amount,0);s2.push([M[i]+'è¨ˆ',f,a,fu,f+a+fu]);}
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s2),'é£Ÿè²»');

  // åŒ»ç™‚è²»
  const ird=loadD('iryohi');
  const s3=[['åŒ»ç™‚è²»ç­‰è²»å†…è¨³è¡¨'],[],['æœˆæ—¥','ç†å®¹ç¾å®¹ä»£','è–¬ãƒ»æ²»ç™‚ä»£','ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ä»£','ãã®ä»–ç”Ÿæ´»ç”¨å“','åˆè¨ˆ','å‚™è€ƒ']];
  ird.filter(e=>isFY(e.date)).forEach(e=>s3.push([e.date,e.type==='beauty'?e.amount:null,e.type==='medical'?e.amount:null,e.type==='cleaning'?e.amount:null,e.type==='daily'?e.amount:null,e.amount,e.memo]));
  for(let i=0;i<12;i++){const es=ird.filter(e=>isFY(e.date)&&getFMI(e.date)===i);const b=es.filter(e=>e.type==='beauty').reduce((a,e)=>a+e.amount,0),m=es.filter(e=>e.type==='medical').reduce((a,e)=>a+e.amount,0),cl=es.filter(e=>e.type==='cleaning').reduce((a,e)=>a+e.amount,0),d=es.filter(e=>e.type==='daily').reduce((a,e)=>a+e.amount,0);s3.push([M[i]+'è¨ˆ',b,m,cl,d,b+m+cl+d]);}
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s3),'åŒ»ç™‚è²»ç­‰');

  // å¤–é£Ÿè²»
  const gsd=loadD('gaishoku');
  const s4=[['å¤–é£Ÿè²»å†…è¨³è¡¨'],[],['æœˆæ—¥','é‡‘é¡','å‚™è€ƒ']];
  gsd.filter(e=>isFY(e.date)).forEach(e=>s4.push([e.date,e.amount,e.memo]));
  for(let i=0;i<12;i++){s4.push([M[i]+'è¨ˆ',gsd.filter(e=>isFY(e.date)&&getFMI(e.date)===i).reduce((a,e)=>a+e.amount,0)]);}
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s4),'å¤–é£Ÿè²»');

  // è¡£æœ
  const ifd=loadD('ifuku');
  const s5=[['è¡£æœå†…è¨³è¡¨'],[],['æœˆæ—¥','é‡‘é¡','å‚™è€ƒ']];
  ifd.filter(e=>isFY(e.date)).forEach(e=>s5.push([e.date,e.amount,e.memo]));
  for(let i=0;i<12;i++){s5.push([M[i]+'è¨ˆ',ifd.filter(e=>isFY(e.date)&&getFMI(e.date)===i).reduce((a,e)=>a+e.amount,0)]);}
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s5),'è¡£æœ');

  // æ—…è¡Œ
  const ryd=loadD('ryoko');
  const s6=[['æ—…è¡Œå†…è¨³è¡¨'],[],['æœˆæ—¥','é‡‘é¡','å‚™è€ƒ']];
  ryd.filter(e=>isFY(e.date)).forEach(e=>s6.push([e.date,e.amount,e.memo]));
  for(let i=0;i<12;i++){s6.push([M[i]+'è¨ˆ',ryd.filter(e=>isFY(e.date)&&getFMI(e.date)===i).reduce((a,e)=>a+e.amount,0)]);}
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s6),'æ—…è¡Œ');

  // ãã®ä»–
  const snd=loadD('sonota');
  const s7=[['ãã®ä»–å†…è¨³è¡¨'],[],['æœˆæ—¥','ãã®ä»–','æœ¬','åˆè¨ˆ','å‚™è€ƒ']];
  snd.filter(e=>isFY(e.date)).forEach(e=>s7.push([e.date,e.type==='other'?e.amount:null,e.type==='book'?e.amount:null,e.amount,e.memo]));
  for(let i=0;i<12;i++){const es=snd.filter(e=>isFY(e.date)&&getFMI(e.date)===i);const o=es.filter(e=>e.type==='other').reduce((a,e)=>a+e.amount,0),bk=es.filter(e=>e.type==='book').reduce((a,e)=>a+e.amount,0);s7.push([M[i]+'è¨ˆ',o,bk,o+bk]);}
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s7),'ãã®ä»–');

  // mycar
  const mcd=loadD('mycar');
  const s8=[['mycaråæ”¯'],[],['æ—¥ä»˜','åå…¥ï¼ˆå¤§ï¼‰','åå…¥ï¼ˆæ´‹å­ï¼‰','é§è»Šå ´ä»£','ã‚¬ã‚½ãƒªãƒ³ä»£','é«˜é€Ÿä»£','ãã®ä»–','åæ”¯','å‚™è€ƒ','ã‚¬ã‚½ãƒªãƒ³â„“','å˜ä¾¡']];
  let bal=0;
  mcd.filter(e=>isFY(e.date)).forEach(e=>{const isI=['income_main','income_sub'].includes(e.type);bal+=isI?e.amount:-e.amount;s8.push([e.date,e.type==='income_main'?e.amount:null,e.type==='income_sub'?e.amount:null,e.type==='parking'?e.amount:null,e.type==='gas'?e.amount:null,e.type==='highway'?e.amount:null,e.type==='other'?e.amount:null,bal,e.memo,e.gasLiter||null,e.gasPrice||null]);});
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s8),'mycaråæ”¯');

  XLSX.writeFile(wb,`ä»¤å’Œ${FY-2018}å¹´åº¦_å®¶è¨ˆç°¿_${FY}.xlsx`);
  showToast(`ä»¤å’Œ${FY-2018}å¹´åº¦_å®¶è¨ˆç°¿_${FY}.xlsx ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHIP EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Default chips per category key
const DEFAULT_CHIPS = {
  shokuhi:  ['ãƒ¢ãƒŠãƒ¢ãƒŠ','ãƒ¨ãƒ¼ã‚¯','æ¥­å‹™ã‚¹ãƒ¼ãƒ‘ãƒ¼','ã‚³ãƒ¼ãƒ—'],
  iryohi:   ['ã‚¯ãƒ©ãƒ©ãƒ³','ã‚¢ãƒ©ã‚»ãƒŠS','ãƒãƒ¼ãƒ•ãƒ ãƒ¼ãƒ³','ã‚¸ãƒ¬ãƒƒãƒˆæ›¿ãˆåˆƒ'],
  gaishoku: ['ä¸²é³¥','çŸ³åºŠ','å®æˆ¸','ã‚«ãƒ•ã‚§ãƒ‰ãƒªãƒ¥ãƒ¼ãƒãƒ³','ãƒ©ãƒ³ãƒ'],
  ifuku:    ['Tã‚·ãƒ£ãƒ„','ã‚·ãƒ£ãƒ„','ã‚ºãƒœãƒ³','ä¸‹ç€','é´','ã‚³ãƒ¼ãƒˆ'],
  ryoko:    ['ä¹å·æ—…è¡Œ','åŒ—æµ·é“æ—…è¡Œ','æ±åŒ—æ—…è¡Œ','ãƒ›ãƒ†ãƒ«','äº¤é€šè²»'],
  sonota:   ['å›ºå®šè³‡ç”£ç¨','Audible','Suicaã‚ªãƒ¼ãƒˆãƒãƒ£ãƒ¼ã‚¸','æ¥½å¤©PAYæœˆè¨ˆ','è‡ªè»¢è»Šä¿é™º','æ¯ã®æ—¥','çˆ¶ã®æ—¥'],
  income:   [],
  mc_income_main:  [],
  mc_income_sub:   [],
  mc_parking:      ['æœˆæ¥µé§è»Šå ´'],
  mc_gas:          ['ã‚³ã‚¹ãƒ¢','ã‚¨ãƒã‚ªã‚¹','å‡ºå…‰'],
  mc_highway:      ['æ±åŒ—é“','ä»™å°å—','ä»™å°åŒ—'],
  mc_other:        ['ä¿é™º','ã‚¿ã‚¤ãƒ¤äº¤æ›','è»Šæ¤œ','æ´—è»Š','ä¿®ç†'],
};

function getUserChips(catKey) {
  const stored = localStorage.getItem(`kb_chips_${catKey}`);
  if (stored !== null) {
    try { return JSON.parse(stored); } catch {}
  }
  return DEFAULT_CHIPS[catKey] || [];
}

function setUserChips(catKey, chips) {
  localStorage.setItem(`kb_chips_${catKey}`, JSON.stringify(chips));
}

function renderChips(containerId, chips, inputId, catKey, catLabel) {
  const el = document.getElementById(containerId);
  el.innerHTML = '';
  chips.forEach(chip => {
    const span = document.createElement('span');
    span.className = 'memo-chip';
    span.textContent = chip;
    span.addEventListener('click', () => setMemo(inputId, chip));
    el.appendChild(span);
  });
  const editBtn = document.createElement('button');
  editBtn.className = 'memo-edit-btn';
  editBtn.textContent = 'âš™ å€™è£œã‚’ç·¨é›†';
  editBtn.addEventListener('click', () => openChipModal(catKey, catLabel, inputId));
  el.appendChild(editBtn);
}

// Modal state
let _modalCatKey = null;
let _modalInputId = null;

function openChipModal(catKey, catLabel, inputId) {
  _modalCatKey = catKey;
  _modalInputId = inputId;
  document.getElementById('chip-modal-title').textContent = `ã€Œ${catLabel}ã€ã®å‚™è€ƒå€™è£œã‚’ç·¨é›†`;
  document.getElementById('chip-new-input').value = '';
  renderModalChips();
  document.getElementById('chip-modal').classList.remove('hidden');
  setTimeout(() => document.getElementById('chip-new-input').focus(), 100);
}

function renderModalChips() {
  const chips = getUserChips(_modalCatKey);
  const list = document.getElementById('chip-modal-list');
  if (!chips.length) {
    list.innerHTML = '<span style="font-size:.78rem;color:var(--muted)">å€™è£œãŒã‚ã‚Šã¾ã›ã‚“</span>';
    return;
  }
  list.innerHTML = chips.map((c, i) =>
    `<span class="modal-chip">${c}<button class="modal-chip-del" onclick="deleteChip(${i})" title="å‰Šé™¤">âœ•</button></span>`
  ).join('');
}

function deleteChip(idx) {
  const chips = getUserChips(_modalCatKey);
  chips.splice(idx, 1);
  setUserChips(_modalCatKey, chips);
  renderModalChips();
  // Refresh displayed chips in the form
  if (_modalInputId) {
    const containerId = _modalInputId === 'e-memo' ? 'memo-chips' : 'mc-chips';
    const cats = eMode === 'income' ? INC_CATS : EXP_CATS;
    const catLabel = eCat ? eCat.label : (TL[mcType] || mcType || '');
    renderChips(containerId, getUserChips(_modalCatKey), _modalInputId, _modalCatKey, catLabel);
  }
}

function addNewChip() {
  const input = document.getElementById('chip-new-input');
  const val = input.value.trim();
  if (!val) return;
  const chips = getUserChips(_modalCatKey);
  if (chips.includes(val)) { showToast('ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™'); return; }
  chips.push(val);
  setUserChips(_modalCatKey, chips);
  input.value = '';
  renderModalChips();
  // Refresh form chips
  if (_modalInputId) {
    const containerId = _modalInputId === 'e-memo' ? 'memo-chips' : 'mc-chips';
    const catLabel = eCat ? eCat.label : (TL[mcType] || mcType || '');
    renderChips(containerId, getUserChips(_modalCatKey), _modalInputId, _modalCatKey, catLabel);
  }
  input.focus();
}

function closeChipModal(event) {
  if (event && event.target !== document.getElementById('chip-modal')) return;
  document.getElementById('chip-modal').classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXCEL IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function importExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
      let imported = 0;

      // Helper: parse date from cell (Excel date serial or string)
      function parseDate(val) {
        if (!val) return null;
        if (val instanceof Date) {
          return val.toISOString().slice(0, 10);
        }
        const s = String(val).trim();
        // YYYY-MM-DD or YYYY/MM/DD
        const m = s.match(/^(\d{4})[\-\/](\d{1,2})[\-\/](\d{1,2})/);
        if (m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
        return null;
      }

      function mergeEntries(cat, newEntries) {
        const existing = loadD(cat);
        const existingKeys = new Set(existing.map(e => `${e.date}_${e.amount}_${e.type}`));
        let added = 0;
        newEntries.forEach(e => {
          const key = `${e.date}_${e.amount}_${e.type}`;
          if (!existingKeys.has(key)) {
            existing.push(e);
            existingKeys.add(key);
            added++;
          }
        });
        existing.sort((a, b) => new Date(a.date) - new Date(b.date));
        saveD(cat, existing);
        return added;
      }

      // â”€â”€ åå…¥ (ç·åˆã‚·ãƒ¼ãƒˆã‹ã‚‰çµ¦ä¸ãƒ»è³ä¸ãƒ»é…å½“) â”€â”€
      if (wb.SheetNames.includes('ç·åˆ')) {
        const ws = wb.Sheets['ç·åˆ'];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        const incEntries = [];
        // rows: find çµ¦ä¸/è³ä¸ç­‰/é…å½“ç­‰ rows (col0=åå…¥, col1=çµ¦ä¸ etc.)
        const typeMap = { 'çµ¦ä¸': 'salary', 'è³ä¸ç­‰': 'bonus', 'é…å½“ç­‰': 'dividend' };
        rows.forEach(row => {
          const item = String(row[1] || '').trim();
          if (typeMap[item]) {
            // cols 2-13 are Apr-Mar monthly totals â€” we store as monthly summary
            // We store as a synthetic entry per month with amount > 0
            for (let i = 0; i < 12; i++) {
              const v = parseFloat(row[2 + i]);
              if (v > 0) {
                // Fiscal month i â†’ actual date (21st of that month)
                const fiscalM = i < 9 ? i + 4 : i - 8;
                const yr = i < 9 ? FY : FY + 1;
                const dateStr = `${yr}-${String(fiscalM).padStart(2,'0')}-21`;
                incEntries.push({ id: Date.now() + Math.random(), date: dateStr, amount: v, memo: '', type: typeMap[item], mode: 'income', cat: 'income' });
              }
            }
          }
        });
        imported += mergeEntries('income', incEntries);
      }

      // â”€â”€ Sheet importers for detail sheets â”€â”€
      function importDetailSheet(sheetName, cat, typeCol, typeMap, memoCol) {
        if (!wb.SheetNames.includes(sheetName)) return 0;
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', cellDates: true });
        const entries = [];
        let headerFound = false;
        for (const row of rows) {
          const col0 = String(row[0] || '').trim();
          // Header row detection
          if (!headerFound) { if (col0 === 'æœˆæ—¥' || col0 === 'æ—¥ä»˜') { headerFound = true; } continue; }
          // Skip month-total rows and empty rows
          if (!col0 || col0.includes('è¨ˆ') || col0.includes('æœˆ')) continue;
          const dateStr = parseDate(row[0]);
          if (!dateStr) continue;
          // Determine type
          let type = null, amount = 0;
          if (typeMap === null) {
            // Single-type sheet (å¤–é£Ÿè²», è¡£æœ, æ—…è¡Œ)
            amount = parseFloat(row[1]) || 0;
            type = cat;
          } else {
            // Multi-type: find which column has value
            for (const [colIdx, t] of Object.entries(typeMap)) {
              const v = parseFloat(row[parseInt(colIdx)]);
              if (v > 0) { type = t; amount = v; break; }
            }
          }
          if (!type || amount <= 0) continue;
          const memo = memoCol !== null ? String(row[memoCol] || '') : '';
          entries.push({ id: Date.now() + Math.random(), date: dateStr, amount, memo, type, mode: 'expense', cat });
        }
        return mergeEntries(cat, entries);
      }

      // é£Ÿè²»: cols [1=food,2=alcohol,3=furusato], memo=5
      imported += importDetailSheet('é£Ÿè²»', 'shokuhi', 'multi',
        {1:'food', 2:'alcohol', 3:'furusato'}, 5);

      // åŒ»ç™‚è²»ç­‰: cols [1=beauty,2=medical,3=cleaning,4=daily], memo=6
      imported += importDetailSheet('åŒ»ç™‚è²»ç­‰', 'iryohi', 'multi',
        {1:'beauty', 2:'medical', 3:'cleaning', 4:'daily'}, 6);

      // å¤–é£Ÿè²»: single, amount=col1, memo=col2
      imported += importDetailSheet('å¤–é£Ÿè²»', 'gaishoku', null, null, 2);

      // è¡£æœ: single
      imported += importDetailSheet('è¡£æœ', 'ifuku', null, null, 2);

      // æ—…è¡Œ: single
      imported += importDetailSheet('æ—…è¡Œ', 'ryoko', null, null, 2);

      // ãã®ä»–: cols [1=other,2=book], memo=4
      imported += importDetailSheet('ãã®ä»–', 'sonota', 'multi',
        {1:'other', 2:'book'}, 4);

      // mycaråæ”¯
      if (wb.SheetNames.includes('mycaråæ”¯')) {
        const ws = wb.Sheets['mycaråæ”¯'];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', cellDates: true });
        const mcEntries = [];
        const mcTypeMap = { 1:'income_main', 2:'income_sub', 3:'parking', 4:'gas', 5:'highway', 6:'other' };
        let headerFound = false;
        for (const row of rows) {
          const col0 = String(row[0] || '').trim();
          if (!headerFound) { if (col0 === 'æ—¥ä»˜') { headerFound = true; } continue; }
          if (!col0 || col0.includes('è¨ˆ')) continue;
          const dateStr = parseDate(row[0]);
          if (!dateStr) continue;
          let type = null, amount = 0;
          for (const [colIdx, t] of Object.entries(mcTypeMap)) {
            const v = parseFloat(row[parseInt(colIdx)]);
            if (v > 0) { type = t; amount = v; break; }
          }
          if (!type || amount <= 0) continue;
          const isInc = ['income_main','income_sub'].includes(type);
          const memo = String(row[8] || '');
          const gasLiter = parseFloat(row[9]) || null;
          const gasPrice = parseFloat(row[10]) || null;
          const e = { id: Date.now() + Math.random(), date: dateStr, amount, memo, type, mode: isInc ? 'income' : 'expense', cat: 'mycar' };
          if (gasLiter) e.gasLiter = gasLiter;
          if (gasPrice) e.gasPrice = gasPrice;
          mcEntries.push(e);
        }
        imported += mergeEntries('mycar', mcEntries);
      }

      renderAll();
      showToast(`${imported}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
      event.target.value = ''; // reset file input
    } catch (err) {
      console.error(err);
      showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MYCAR SUB-PANELS (é›†è¨ˆãƒ»å±¥æ­´)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showMcSub(type) {
  // Close the other one first
  const other = type === 'summary' ? 'history' : 'summary';
  document.getElementById(`mc-sub-${other}`).classList.add('hidden');
  document.getElementById(`mclink-${other}`).style.fontWeight = '';

  const panel = document.getElementById(`mc-sub-${type}`);
  const link  = document.getElementById(`mclink-${type}`);
  panel.classList.remove('hidden');
  link.style.fontWeight = '600';
  link.style.color = 'var(--purple)';

  if (type === 'summary') renderMcSummaryInline();
  if (type === 'history')  renderMcHistory();
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function hideMcSub(type) {
  document.getElementById(`mc-sub-${type}`).classList.add('hidden');
  const link = document.getElementById(`mclink-${type}`);
  link.style.fontWeight = '';
  link.style.color = '';
}

function renderMcSummaryInline() {
  // same as renderMcSummary but writes to mc-sum-body2
  const data = loadD('mycar').filter(e => isFY(e.date));
  const mcTypes = ['income_main','income_sub','parking','gas','highway','other'];
  const mt = {};
  mcTypes.forEach(t => { mt[t] = new Array(12).fill(0); });
  data.forEach(e => { if (mt[e.type]) mt[e.type][getFMI(e.date)] += +e.amount || 0; });
  const totInc = mt.income_main.map((v,i) => v + mt.income_sub[i]);
  const totExp = mt.parking.map((v,i) => v + mt.gas[i] + mt.highway[i] + mt.other[i]);
  const row = (l,d) => { const t=d.reduce((a,b)=>a+b,0); return `<tr><td>${l}</td>${d.map(v=>`<td>${v?fmt(v):'â€”'}</td>`).join('')}<td>${fmt(t)}</td></tr>`; };
  const sub = (l,d) => { const t=d.reduce((a,b)=>a+b,0); return `<tr class="sub"><td>${l}</td>${d.map(v=>`<td>${fmt(v)}</td>`).join('')}<td>${fmt(t)}</td></tr>`; };
  const body = document.getElementById('mc-sum-body2');
  if (body) body.innerHTML =
    row('åå…¥ï¼ˆå¤§ï¼‰',mt.income_main) + row('åå…¥ï¼ˆæ´‹å­ï¼‰',mt.income_sub) + sub('åå…¥ã€€è¨ˆ',totInc) +
    row('é§è»Šå ´ä»£',mt.parking) + row('ã‚¬ã‚½ãƒªãƒ³ä»£',mt.gas) + row('é«˜é€Ÿä»£',mt.highway) + row('ãã®ä»–',mt.other) + sub('æ”¯å‡ºã€€è¨ˆ',totExp);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}
</script>

<!-- â•â• CHIP EDITOR MODAL â•â• -->
<div class="modal-overlay hidden" id="chip-modal" onclick="closeChipModal(event)">
  <div class="modal">
    <div class="modal-hdr">
      <h3 id="chip-modal-title">å‚™è€ƒå€™è£œã‚’ç·¨é›†</h3>
      <button class="modal-close" onclick="closeChipModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-chip-list" id="chip-modal-list"></div>
      <div class="modal-add-row">
        <input type="text" id="chip-new-input" placeholder="æ–°ã—ã„å€™è£œã‚’å…¥åŠ›" onkeydown="if(event.key==='Enter')addNewChip()">
        <button onclick="addNewChip()">è¿½åŠ </button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
